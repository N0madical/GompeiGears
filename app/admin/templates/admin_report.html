{% extends "admin_base.html" %}
{% import "_form_field.html" as wtf %}

{% block content %}
    <h1 class="admin-title">Maintenance Reports</h1>
    <div class="display-tab-inline">
        <button id="ongoing_button" onClick="swap_to_ongoing()" class="admin-tab admin-tab-main">Reports</button>
        <button id="comp_button" onClick="swap_to_comp()" class="admin-tab" style="transform: translateX(-15px)">Completed Reports</button>
    </div>

    <hr class="red-hr" >
    
    <form id="my_form" method ="POST" action="" class="d-flex flex-wrap align-items-center text-nowrap p-2">
        
        {{form.hidden_tag()}}
        <span class="sort-span fw-bold me-3 mb-1">Filter by: </span>
        {{ form.search(id="search_bar", class="form-control me-5 w-50 my-1", placeholder="Search...") }}
        {{form.category(id="category_box", class="form-control")}}
        {{ form.submit(class="btn btn-dark mt-1") }}
    </form>
    <div class="w-100 overflow-scroll">
        <table id="reports_table" class="admin-table text-nowrap">
            <tr class="bg-wpi-grey">
                <th>User</th>
                <th>Bike</th>
                <th>Category</th>
                <th>Description (km)</th>
                <th>Report Status</th>
                <th>Bike Availability</th>
            </tr>
        </table>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="report_desc" tabindex="-1" aria-labelledby="report_descLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal_title_box">Report Description</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="form-control" id="description_box"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let active_page = 0;
        let query;
        let reportTypes = {'1' : "Brake", '2' : "App", '3' : "Tire",
            '4' : "Lock", '5' : "Gear", '6' : "Frame", '7' : "Other"
        }

        document.getElementById('report_desc').addEventListener('show.bs.modal', function (event) {
            my_modal = document.getElementById('report_desc');
            button = event.relatedTarget
            var report_data = button.getAttribute('data-bs-whatever')
            var modal_body = my_modal.querySelector('#description_box')
            modal_body.innerHTML = report_data
        })

        document.getElementById("my_form").addEventListener("submit", event => {
            event.preventDefault();// disable the default behavior when the form is submitted
            build_table();
        })

        async function swap_to_ongoing(){
            console.log("swap to ongoing")
            document.getElementById("ongoing_button").classList.add("admin-tab-main");
            document.getElementById("comp_button").classList.remove("admin-tab-main");
            active_page = 0;
            build_table();
        }

        async function swap_to_comp(){
            console.log("swap to comp")
            document.getElementById("comp_button").classList.add("admin-tab-main");
            document.getElementById("ongoing_button").classList.remove("admin-tab-main");
            active_page = 1;
            build_table();
        }

        async function toggle_report_completion(my_url){
            try {
                const response = await fetch(my_url, {
                method: 'POST'});
                build_table();
            } catch(error) {
                console.error(error.message);
            }
        }


        async function toggle_bike_availability(my_url) {
            try {
                const response = await fetch(my_url, {
                method: 'POST'});
                build_table();
            } catch(error) {
                console.error(error.message);
            }
        }

        async function clear_table(){
            table = document.getElementById("reports_table");
            my_rows = document.getElementById("reports_table").getElementsByClassName("my_table_row");
            for (let i = my_rows.length; i > 0; i--){
                table.deleteRow(i);
            }
        }

        async function build_table(){
            table = document.getElementById("reports_table");
            search_field = document.getElementById("search_bar").value;
            fetch('{{url_for("admin.filter_admin_reports")}}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({'search': search_field,
                    'category': document.getElementById("category_box").value,
                    'completed': active_page
                })
            }).then(response => response.json())
            .then(data => {query = data;
                clear_table();
                console.log(query)
                for (let i = 0; i < query["result"].length; i++) {
                    let tr_elm = document.createElement("tr");
                    tr_elm.style.vAlign = 'middle';
                    tr_elm.classList.add("my_table_row")
                    tr_elm.style.borderBottom = "solid 2px #A9B0B7";
                    let td_name = document.createElement("td");
                    let a_name = document.createElement("a")
                    a_name.textContent = query["result"][i].name + " (" + query["result"][i].email + ")";
                    a_name.href = "{{ url_for('admin.load_admin_users') }}?q=" + query["result"][i].email
                    td_name.append(a_name)
                    tr_elm.appendChild(td_name);
                    let td_bike = document.createElement("td");
                    let a_bike = document.createElement("a")
                    a_bike.textContent = query["result"][i].bike + " (" + query["result"][i].bike_id + ")";
                    a_bike.href = "{{ url_for('admin.assets') }}#" + query["result"][i].bike
                    td_bike.append(a_bike)
                    tr_elm.appendChild(td_bike);
                    let td_cat = document.createElement("td");
                    let text;
                    if (query["result"][i].cat == 1) {
                        text = "Brake Issue" 
                    } else if (query["result"][i].cat == 2) {
                        text = "App Issue";
                    } else if (query["result"][i].cat == 3) {
                        text = "Tire Issue";
                    } else if (query["result"][i].cat == 4) {
                        text = "Lock Issue";
                    } else if (query["result"][i].cat == 5) {
                        text = "Gear Issue";
                    } else if (query["result"][i].cat == 6) {
                        text = "Frame Issue";
                    } else {
                        text = "Other";
                    }
                    td_cat.innerHTML = text;
                    tr_elm.appendChild(td_cat);
                    let td_desc = document.createElement("td");
                    td_desc.innerHTML = `<button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#report_desc" data-bs-whatever="${query["result"][i].desc}">
                                            Open Description
                                        </button>`;
                    tr_elm.appendChild(td_desc);
                    let td_comp = document.createElement("td");
                    if (query["result"][i].comp == 0) {
                        text = "Mark Complete"
                    } else {
                        text = "Mark Incomplete"
                    }
                    td_comp.innerHTML = `<button type="button" onClick="toggle_report_completion('/admin/reports/toggle/report?bike_id=${query["result"][i].bike_id}&user_id=${query["result"][i].user_id}&timestamp=${query["result"][i].timestamp}')" class="btn btn-outline-secondary">${text}</button>`;
                    tr_elm.appendChild(td_comp);
                    let td_avail = document.createElement("td");
                    if (query["result"][i].avail == 0){
                        text = "Mark Bike Available"
                    } else {
                        text = "Mark Bike Unavailable"
                    }
                    td_avail.innerHTML = `<button type="button" onClick="toggle_bike_availability('/admin/reports/toggle/bike?bike_id=${query["result"][i].bike_id}')" class="btn btn-outline-secondary">${text}</button>`;
                    tr_elm.appendChild(td_avail);
                    table.appendChild(tr_elm);
            }
            });
        }

        const url = new URL(location.href)
        if (url.searchParams.has("q")) {
            document.getElementById("my_form").elements[1].value = url.searchParams.get("q")
        }

        if (url.searchParams.has("p") && url.searchParams.get("p") === "1") {
            swap_to_comp();
        } else {
            build_table();
        }
        setInterval(build_table, 15000);
    </script>


    
{% endblock %}